name: CMake Deploy


on:

  push:

    branches: [ "main" ]

    tags: [ "*" ]   

  pull_request: 

    branches: [ "main" ]


permissions:

  contents: write


env:

  BUILD_TYPE: Debug


jobs:

  build-win:

    runs-on: windows-latest


    steps:

    - uses: actions/checkout@v3


    - name: Install Qt

      id: install-qt

      uses: jurplel/install-qt-action@v4

      with:

        version: '6.9.1'

        host: 'windows'

        target: 'desktop'

        arch: 'win64_msvc2022_64'

        modules: 'qtmultimedia'

        tools: 'tools_ifw'

        install-deps: "true"


    - name: Configure MSVC

      uses: TheMrMilchmann/setup-msvc-dev@v3

      with:

        arch: x64


    - name: Configure CMake

      run: cmake -S . -B ${{github.workspace}}/build 


    - name: Build

      run: cmake --build ${{github.workspace}}/build 


    - name: Test

      working-directory: ${{github.workspace}}/build

      run: ctest -C ${{env.BUILD_TYPE}}


    - name: Upload Release (Tag Push - Final Release)

      if: startsWith(github.ref, 'refs/tags/')

      uses: softprops/action-gh-release@v1

      with:

        files: |

          dist.zip

          qff_installer.exe

        draft: false

      env:

        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}


    - name: Upload Draft Release (Untagged Push)

      if: github.ref == 'refs/heads/main'

      uses: softprops/action-gh-release@v1

      with:

        name: "Development Build - ${{ github.sha }}"

        tag_name: "dev"

        files: |

          dist.zip

          qff_installer.exe

        draft: true

        prerelease: true

      env:

        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} 